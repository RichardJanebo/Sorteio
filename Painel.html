<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Admin - Natal da Sorte</title>
    <link rel="stylesheet" href="Styles.css">
</head>
<body class="admin-page">
    <!-- Modal de autentica√ß√£o -->
    <div id="auth-modal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 9999; display: flex; align-items: center; justify-content: center;">
        <div style="background: linear-gradient(180deg, #ffffff 0%, #f7f7fa 100%); padding: 40px; border-radius: 20px; max-width: 400px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.4); border: 1px solid rgba(0,0,0,0.1);">
            <h2 style="color: #0b6b4a; margin-bottom: 10px; text-align: center;">üîí Acesso Restrito</h2>
            <p style="color: #566070; margin-bottom: 30px; text-align: center;">Digite suas credenciais para acessar o painel</p>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; color: #344054; font-weight: 700; margin-bottom: 8px;">Usu√°rio</label>
                <input type="text" id="admin-user" placeholder="Digite o usu√°rio" style="width: 100%; padding: 12px 16px; border: 1px solid #e4e7ec; border-radius: 10px; font-size: 1em;">
            </div>
            
            <div style="margin-bottom: 30px;">
                <label style="display: block; color: #344054; font-weight: 700; margin-bottom: 8px;">Senha</label>
                <input type="password" id="admin-pass" placeholder="Digite a senha" style="width: 100%; padding: 12px 16px; border: 1px solid #e4e7ec; border-radius: 10px; font-size: 1em;">
            </div>
            
            <button onclick="checkAuth()" style="width: 100%; background: linear-gradient(135deg, #0b6b4a 0%, #074d35 100%); color: white; border: none; padding: 14px; border-radius: 12px; font-size: 1.1em; font-weight: 800; cursor: pointer; box-shadow: 0 10px 24px rgba(11, 107, 74, 0.35);">Entrar</button>
            
            <div id="auth-error" style="display: none; margin-top: 15px; padding: 12px; background: #f9e3e3; color: #7a2029; border-radius: 8px; text-align: center; font-weight: 600;"></div>
        </div>
    </div>

    <div id="admin-content" style="display: none;">
    <div class="header">
        <h1>üéÑ Painel Administrativo - Natal da Sorte</h1>
        <p>Gerencie os participantes e acompanhe os n√∫meros da sorte em tempo real</p>
        <div style="margin-top: 10px; display: flex; gap: 10px; flex-wrap: wrap;">
            <button id="clear-all-btn" class="btn btn-delete" style="background:#dc3545;color:#fff;">üßπ Apagar dados</button>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <h3>Total de Usu√°rios</h3>
            <div class="number" id="total-users">0</div>
        </div>
        <div class="stat-card">
            <h3>Usu√°rios Online</h3>
            <div class="number" id="online-users" style="color: #28a745;">0</div>
        </div>
        <div class="stat-card">
            <h3>N√∫meros Revelados</h3>
            <div class="number" id="total-numbers">0</div>
        </div>
        <div class="stat-card">
            <h3>Aguardando N√∫mero</h3>
            <div class="number" id="waiting-users">0</div>
        </div>
    </div>

    <div class="lucky-numbers-section">
        <h2>üéÅ N√∫meros da Sorte Revelados</h2>
        <div class="numbers-grid" id="numbers-grid">
            <div class="empty-state">
                <p>Nenhum n√∫mero revelado ainda</p>
            </div>
        </div>
    </div>

    <div class="users-section">
        <h2>üë• Usu√°rios Cadastrados</h2>
        
        <div class="search-bar">
            <input type="text" id="search-input" placeholder="üîç Buscar por n√∫mero da sorte, nome, e-mail ou telefone...">
        </div>

        <div class="users-table">
            <table>
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>E-mail</th>
                        <th>Telefone</th>
                        <th>Chave PIX</th>
                        <th>N√∫mero da Sorte</th>
                        <th>Status</th>
                        <th>Online</th>
                        <th>Data/Hora</th>
                    </tr>
                </thead>
                <tbody id="users-tbody">
                    <tr>
                        <td colspan="7" class="empty-state">
                            <p>Nenhum usu√°rio cadastrado ainda</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <button class="refresh-btn" onclick="loadData()" title="Atualizar dados">
        üîÑ
    </button>

    <script>
        let allUsers = [];
        let luckyNumbers = [];

        // Carregar dados do localStorage
        function loadData() {
            loadUsers();
            loadLuckyNumbers();
            updateStats();
        }

        // Carregar usu√°rios
        function loadUsers() {
            // Buscar todos os usu√°rios do localStorage
            const users = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('user_')) {
                    try {
                        const userData = JSON.parse(localStorage.getItem(key));
                        userData.id = key;
                        users.push(userData);
                    } catch (e) {
                        console.error('Erro ao carregar usu√°rio:', e);
                    }
                }
            }

            allUsers = users;
            displayUsers(users);
        }

        // Exibir usu√°rios na tabela
        function displayUsers(users) {
            const tbody = document.getElementById('users-tbody');
            
            if (users.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="empty-state">
                            <p>Nenhum usu√°rio cadastrado ainda</p>
                        </td>
                    </tr>
                `;
                return;
            }

            const now = new Date();
            tbody.innerHTML = users.map(user => {
                const hasNumber = user.luckyNumber && user.luckyNumber !== '0000';
                const status = hasNumber ? 'active' : 'waiting';
                const statusText = hasNumber ? 'N√∫mero Revelado' : 'Aguardando';
                const timestamp = user.timestamp ? new Date(user.timestamp).toLocaleString('pt-BR') : '-';
                
                // Verificar se est√° online: precisa da flag e ao menos 1 sess√£o ativa
                const uid = (user.email || '').replace(/[^a-zA-Z0-9]/g, '_');
                const sessions = parseInt(localStorage.getItem('activeSessions_user_' + uid) || '0', 10) || 0;
                const isOnline = (user.status_online === 'online') && sessions > 0;
                const onlineStatus = isOnline ? 'online' : 'offline';
                const onlineText = isOnline ? 'Online' : 'Offline';

                return `
                    <tr>
                        <td><strong>${user.name || '-'}</strong></td>
                        <td>${user.email || '-'}</td>
                        <td>${user.phone || '-'}</td>
                        <td>${user.pix || '-'}</td>
                        <td><strong style="color: #c41e3a; font-size: 1.2em;">${user.luckyNumber || '0000'}</strong></td>
                        <td><span class="badge ${status}">${statusText}</span></td>
                        <td>
                            <span class="status-indicator ${onlineStatus}">
                                <span class="status-dot ${onlineStatus}"></span>
                                ${onlineText}
                            </span>
                        </td>
                        <td>${timestamp}</td>
                    </tr>
                `;
            }).join('');
        }

        // Carregar n√∫meros da sorte
        function loadLuckyNumbers() {
            const numbers = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('luckyNumber_')) {
                    try {
                        const data = JSON.parse(localStorage.getItem(key));
                        numbers.push(data);
                    } catch (e) {
                        console.error('Erro ao carregar n√∫mero:', e);
                    }
                }
            }

            luckyNumbers = numbers.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            displayLuckyNumbers(numbers);
        }

        // Exibir n√∫meros da sorte
        function displayLuckyNumbers(numbers) {
            const grid = document.getElementById('numbers-grid');
            
            if (numbers.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <p>Nenhum n√∫mero revelado ainda</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = numbers.map(item => {
                const date = new Date(item.timestamp).toLocaleString('pt-BR');
                return `
                    <div class="number-card">
                        <div class="lucky-number">${item.number}</div>
                        <div class="user-name">${item.userName}</div>
                        <div class="timestamp">${date}</div>
                    </div>
                `;
            }).join('');
        }

        // Atualizar estat√≠sticas
        function updateStats() {
            const now = new Date();
            const totalUsers = allUsers.length;
            const usersWithNumbers = allUsers.filter(u => u.luckyNumber && u.luckyNumber !== '0000').length;
            const waitingUsers = totalUsers - usersWithNumbers;
            
            // Contar usu√°rios online pela flag e sess√µes ativas
            const onlineUsers = allUsers.filter(u => {
                const uid = (u.email || '').replace(/[^a-zA-Z0-9]/g, '_');
                const sessions = parseInt(localStorage.getItem('activeSessions_user_' + uid) || '0', 10) || 0;
                return u.status_online === 'online' && sessions > 0;
            }).length;

            document.getElementById('total-users').textContent = totalUsers;
            document.getElementById('online-users').textContent = onlineUsers;
            document.getElementById('total-numbers').textContent = usersWithNumbers;
            document.getElementById('waiting-users').textContent = waitingUsers;
        }

        // Buscar usu√°rios
        document.getElementById('search-input').addEventListener('input', (e) => {
            const search = e.target.value.toLowerCase();
            const filtered = allUsers.filter(user => 
                (user.luckyNumber || '').toLowerCase().includes(search) ||
                (user.name || '').toLowerCase().includes(search) ||
                (user.email || '').toLowerCase().includes(search) ||
                (user.phone || '').toLowerCase().includes(search)
            );
            displayUsers(filtered);
        });

        // Monitorar mudan√ßas no localStorage
        window.addEventListener('storage', (e) => {
            loadData();
        });

        // Atualizar automaticamente a cada 5 segundos
        setInterval(() => {
            loadData();
        }, 5000);

        // Carregar dados iniciais
        loadData();

        // Bot√£o: Recarregar dados
        document.getElementById('reload-btn').addEventListener('click', loadData);

        // Bot√£o: Limpar todos os dados
        document.getElementById('clear-all-btn').addEventListener('click', () => {
            const confirmClear = confirm('Tem certeza que deseja apagar TODOS os dados (usu√°rios, n√∫meros, status)? Essa a√ß√£o n√£o pode ser desfeita.');
            if (!confirmClear) return;

            try {
                // Preservar autentica√ß√£o do admin
                const adminAuth = sessionStorage.getItem('adminAuth');
                localStorage.clear();
                if (adminAuth) {
                    sessionStorage.setItem('adminAuth', adminAuth);
                }
                // Feedback visual
                const tbody = document.getElementById('users-tbody');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="empty-state">
                            <p>Nenhum usu√°rio cadastrado ainda</p>
                        </td>
                    </tr>
                `;
                const grid = document.getElementById('numbers-grid');
                grid.innerHTML = `
                    <div class="empty-state">
                        <p>Nenhum n√∫mero revelado ainda</p>
                    </div>
                `;
                document.getElementById('total-users').textContent = '0';
                const onlineEl = document.getElementById('online-users');
                if (onlineEl) onlineEl.textContent = '0';
                document.getElementById('total-numbers').textContent = '0';
                document.getElementById('waiting-users').textContent = '0';
                alert('Todos os dados foram apagados. Ambiente limpo!');
            } catch (e) {
                console.error('Erro ao limpar dados:', e);
                alert('N√£o foi poss√≠vel apagar os dados. Veja o console para detalhes.');
            }
        });

        // Sistema de autentica√ß√£o
        function checkAuth() {
            const username = document.getElementById('admin-user').value;
            const password = document.getElementById('admin-pass').value;
            const errorDiv = document.getElementById('auth-error');

            if (username === 'Roberto' && password === '2025') {
                sessionStorage.setItem('adminAuth', 'true');
                document.getElementById('auth-modal').style.display = 'none';
                document.getElementById('admin-content').style.display = 'block';
                errorDiv.style.display = 'none';
                // Carregar dados ap√≥s autentica√ß√£o
                loadUsers();
                loadNumbers();
            } else {
                errorDiv.textContent = '‚ùå Usu√°rio ou senha incorretos';
                errorDiv.style.display = 'block';
            }
        }

        // Verificar autentica√ß√£o ao carregar a p√°gina
        window.addEventListener('DOMContentLoaded', function() {
            if (sessionStorage.getItem('adminAuth') === 'true') {
                document.getElementById('admin-content').style.display = 'block';
            } else {
                document.getElementById('auth-modal').style.display = 'flex';
            }
        });

        // Permitir login com Enter
        document.addEventListener('DOMContentLoaded', function() {
            const passInput = document.getElementById('admin-pass');
            if (passInput) {
                passInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        checkAuth();
                    }
                });
            }
        });
    </script>
</body>
</html>


